name: doubaoime-install

on:
  workflow_dispatch:
    inputs:
      source_ref:
        description: "Git ref (branch/tag/sha) in SOURCE_REPO"
        required: true
        default: "main"

permissions:
  contents: read

jobs:
  install:
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60

    steps:
      - name: Checkout BUILD_REPO
        uses: actions/checkout@v4

      - name: Host info (debug)
        run: |
          set -euo pipefail
          uname -a
          id
          ls -la /dev/kvm || true
          lsmod | head -n 50 || true

      - name: Install emulator dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            libpulse0 \
            libglu1-mesa \
            libnss3 \
            libx11-6 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxtst6 \
            libasound2 \
            libdbus-1-3 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0

      - name: Start ssh-agent (SOURCE_REPO deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}

      - name: Add github.com to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone SOURCE_REPO
        run: |
          git clone --depth 1 --branch "${{ inputs.source_ref }}" git@github.com:FuChuZhao/doubaoime-ci-source-20260224.git source

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Run install test
        env:
          AVD_NAME: doubao_arm64_${{ github.run_id }}
        run: |
          set -euo pipefail
          cd source
          bash tool/ci/run.sh --avd-name "${AVD_NAME}" --artifact-dir artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: doubaoime-install-artifacts
          path: source/artifacts
          retention-days: 1
